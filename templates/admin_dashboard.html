{% extends "base.html" %}

{% block title %}Admin Dashboard - Car Price Prediction{% endblock %}

{% block content %}
<div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="sidebar text-white shadow-glow">
        <div class="p-6 border-b border-blue-700/30">
            <div class="flex items-center space-x-3">
                <div class="h-10 w-10 rounded-full glass-effect flex items-center justify-center">
                    <i class="fas fa-shield-alt text-green-300"></i>
                </div>
                <div>
                    <div class="text-sm text-blue-200">Admin Panel</div>
                    <div class="font-semibold text-white">{{ session.username }}</div>
                </div>
            </div>
        </div>

        <nav class="p-4 space-y-2">
            <button class="w-full text-left flex items-center px-3 py-3 rounded-lg hover:bg-blue-600/30 transition-all duration-300 sidebar-link bg-blue-600/30" data-target="overview">
                <i class="fas fa-tachometer-alt w-6 text-green-300"></i>
                <span class="ml-2">Dashboard</span>
            </button>
            <button class="w-full text-left flex items-center px-3 py-3 rounded-lg hover:bg-blue-600/30 transition-all duration-300 sidebar-link" data-target="users">
                <i class="fas fa-users w-6 text-green-300"></i>
                <span class="ml-2">Users</span>
            </button>
            <button class="w-full text-left flex items-center px-3 py-3 rounded-lg hover:bg-blue-600/30 transition-all duration-300 sidebar-link" data-target="predictions">
                <i class="fas fa-database w-6 text-green-300"></i>
                <span class="ml-2">Predictions</span>
            </button>
            <button class="w-full text-left flex items-center px-3 py-3 rounded-lg hover:bg-blue-600/30 transition-all duration-300 sidebar-link" data-target="analytics">
                <i class="fas fa-chart-line w-6 text-green-300"></i>
                <span class="ml-2">Reports</span>
            </button>


        </nav>
    </aside>

    <!-- Main content -->
    <section class="flex-1 ml-[250px] mt-16 p-6 bg-gradient-to-br from-blue-50 via-white to-green-50">
            <!-- Overview Section (full width page, not cards) -->
            <div id="section-overview" class="section">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-gray-900">Overview</h2>
                    <p class="text-sm text-gray-600">Key metrics at a glance</p>
                </div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="card-gradient rounded-xl border border-gray-200 p-6 shadow-glow hover-lift">
                        <div class="flex items-center">
                            <div class="p-4 rounded-lg bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow-glow">
                                <i class="fas fa-users text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <div class="text-3xl font-semibold text-gray-900">{{ total_users }}</div>
                                <div class="text-gray-600">Total Users</div>
                            </div>
                        </div>
                    </div>
                    <div class="card-gradient rounded-xl border border-gray-200 p-6 shadow-glow hover-lift">
                        <div class="flex items-center">
                            <div class="p-4 rounded-lg bg-gradient-to-br from-green-500 to-green-600 text-white shadow-glow">
                                <i class="fas fa-calculator text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <div class="text-3xl font-semibold text-gray-900">{{ total_predictions }}</div>
                                <div class="text-gray-600">Total Predictions</div>
                            </div>
                        </div>
                    </div>
                </div>



                <div class="mt-8 card-gradient rounded-xl border border-gray-200 p-6 shadow-glow">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">
                            <i class="fas fa-history mr-2 text-blue-600"></i>Recent Predictions
                        </h3>
                        <button onclick="viewAllPredictions()" class="text-sm text-blue-600 hover:text-blue-800 transition-colors">View all</button>
                    </div>
                    {% if recent_predictions %}
                        <div class="divide-y divide-gray-200">
                            {% for prediction in recent_predictions[:8] %}
                            <div class="py-4 flex items-center justify-between hover:bg-gray-50 rounded-lg px-2 transition-colors">
                                <div>
                                    <div class="font-semibold text-gray-800">{{ prediction.username }}</div>
                                    <div class="text-sm text-gray-600">
                                        {{ prediction.year }} Model | {{ prediction.engine_size }}L | {% if prediction.transmission_manual == 1 %}Manual{% else %}Automatic{% endif %}
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="font-semibold text-green-600">${{ "%.0f"|format(prediction.predicted_price) }}</div>
                                    <div class="text-xs text-gray-500">{{ prediction.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-2 text-gray-300"></i>
                            <p>No predictions yet</p>
                        </div>
                    {% endif %}
                </div>

                <div class="mt-8 rounded-xl border border-gray-200 bg-white p-5 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900"><i class="fas fa-chart-area mr-2 text-gray-700"></i>Usage Reports</h3>
                        <div class="flex space-x-2">
                            <button onclick="changeChartPeriod('7d')" class="px-3 py-1 rounded-md text-sm bg-green-600 text-white hover:bg-green-700 transition">7 Days</button>
                            <button onclick="changeChartPeriod('30d')" class="px-3 py-1 rounded-md text-sm bg-gray-100 text-gray-700 hover:bg-gray-200 transition">30 Days</button>
                            <button onclick="changeChartPeriod('90d')" class="px-3 py-1 rounded-md text-sm bg-gray-100 text-gray-700 hover:bg-gray-200 transition">90 Days</button>
                        </div>
                    </div>
                    <div class="h-64 flex items-center justify-center bg-gray-50 rounded-lg">
                        <canvas id="analyticsChart" width="800" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Users Management Section -->
            <div id="section-users" class="section hidden">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="text-2xl font-semibold text-gray-900">User Management</h2>
                        <p class="text-sm text-gray-500">View and manage all users</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="relative">
                            <input id="userSearch" type="text" placeholder="Search users..." class="pl-9 pr-3 py-2 border border-gray-300 rounded-md w-64 focus:outline-none focus:ring-2 focus:ring-gray-300" oninput="filterUsers()">
                            <i class="fas fa-search text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                        </div>
                        <button onclick="exportUsers()" class="inline-flex items-center rounded-md bg-green-600 px-3 py-2 text-sm font-medium text-white hover:bg-green-700 transition"><i class="fas fa-download mr-2"></i>Export</button>
                    </div>
                </div>

                <div class="rounded-xl border border-gray-200 bg-white overflow-hidden shadow-sm">
                    <div class="bg-gray-50 px-4 py-3 flex items-center justify-between">
                        <div class="text-sm text-gray-600"><span id="usersCount">0</span> users</div>
                        <div class="text-sm text-gray-500">Click a row to view details</div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full table-auto" id="usersTable">
                            <thead>
                                <tr class="text-left text-sm text-gray-600 border-b">
                                    <th class="px-4 py-3">Username</th>
                                    <th class="px-4 py-3">Email</th>
                                    <th class="px-4 py-3">Joined</th>
                                    <th class="px-4 py-3">Predictions</th>
<th class="px-4 py-3">Actions</th>
                                </tr>
                            </thead>
<tbody id="usersBody">
                                <tr>
                                    <td colspan="5" class="px-4 py-6 text-center text-gray-500">Loading users...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Inline User Detail Card pinned/top of viewport for quick viewing -->
                <div id="userDetailCard" class="mt-4"></div>
            </div>

            <!-- Analytics Section -->
            <div id="section-analytics" class="section hidden">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Reports</h2>
                <div class="space-x-2 mb-4">
                    <button onclick="viewAnalytics()" class="inline-flex items-center rounded-md bg-green-600 px-3 py-2 text-sm font-medium text-white hover:bg-green-700 transition"><i class="fas fa-chart-line mr-2"></i>View Reports</button>
                    <button onclick="exportReports()" class="inline-flex items-center rounded-md bg-gray-100 px-3 py-2 text-sm font-medium text-gray-800 hover:bg-gray-200 transition"><i class="fas fa-file-export mr-2"></i>Export Reports</button>
                </div>
                <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
                    <div class="h-64 flex items-center justify-center bg-gray-50 rounded-lg">
                        <canvas id="analyticsChart2" width="800" height="200"></canvas>
                    </div>
                </div>
            </div>



            <!-- Predictions Section -->
            <div id="section-predictions" class="section hidden">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="text-2xl font-semibold text-gray-900">All Predictions</h2>
                        <p class="text-sm text-gray-500">Review, view details, and delete predictions</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input id="predSearch" type="text" placeholder="Search by user..." class="pl-3 pr-3 py-2 border border-gray-300 rounded-md w-64 focus:outline-none focus:ring-2 focus:ring-gray-300" oninput="filterPredictions()">
                    </div>
                </div>

                <div class="rounded-xl border border-gray-200 bg-white overflow-hidden shadow-sm">
                    <div class="bg-gray-50 px-4 py-3 flex items-center justify-between">
                        <div class="text-sm text-gray-600"><span id="predCount">0</span> predictions</div>
                        <div class="text-sm text-gray-500">Tip: Use the trash icon to delete an entry</div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full table-auto" id="predictionsTable">
                            <thead>
                                <tr class="text-left text-sm text-gray-600 border-b">
                                    <th class="px-4 py-3">User</th>
                                    <th class="px-4 py-3">Date</th>
                                    <th class="px-4 py-3">Spec</th>
                                    <th class="px-4 py-3">Price</th>
                                    <th class="px-4 py-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="predictionsBody">
                                <tr>
                                    <td colspan="5" class="px-4 py-6 text-center text-gray-500">Loading predictions...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="flex items-center justify-between p-3 border-t">
                        <div class="text-sm text-gray-600">Page <span id="predPage">1</span></div>
                        <div class="space-x-2">
                            <button class="px-3 py-1 rounded-md bg-gray-100 hover:bg-gray-200 text-sm" onclick="prevPredPage()">Prev</button>
                            <button class="px-3 py-1 rounded-md bg-gray-100 hover:bg-gray-200 text-sm" onclick="nextPredPage()">Next</button>
                        </div>
                    </div>
                </div>
                <div id="predDetailCard" class="mt-4"></div>
            </div>

            <!-- Settings Section removed -->
        </div>
    </section>
</div>

<!-- Users Modal (reused) -->
<div id="usersModal" class="fixed inset-0 bg-black bg-opacity-40 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl border border-gray-200 max-w-4xl w-full p-6 max-h-96 overflow-y-auto shadow-xl">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">All Users</h3>
                <button onclick="closeUsersModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="usersContent">
                <!-- Users list will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
let allUsers = [];
let allPredictions = [];
let predPage = 1;
let predPageSize = 20;

function loadUsersIntoTable(users) {
    const tbody = document.getElementById('usersBody');
    const count = document.getElementById('usersCount');
    if (!tbody) return;
    if (!users || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-gray-500">No users found</td></tr>';
        if (count) count.textContent = '0';
        return;
    }
    let html = '';
    users.forEach(user => {
        const joined = user.created_at ? new Date(user.created_at).toLocaleDateString() : '-';
        // Use MongoDB ObjectId string exactly as provided by backend.
        const oid = (user._id ?? user.id ?? '').toString();
html += `
            <tr class="border-b hover:bg-blue-50 cursor-pointer" data-user-id="${oid}" onclick="viewUserRow(this)">
                <td class="px-4 py-3 font-medium text-gray-800">${user.username}</td>
                <td class="px-4 py-3">${user.email}</td>
                <td class="px-4 py-3">${joined}</td>
                <td class="px-4 py-3">${(user.prediction_count ?? user.predictions ?? user.count ?? 0)}</td>
                <td class="px-4 py-3 space-x-2">
                    <button onclick="event.stopPropagation(); openUpdateUser('${oid}', '${user.username}', '${user.email}')" class="text-blue-600 hover:text-blue-800 text-sm">
                        <i class="fas fa-edit mr-1"></i>Update
                    </button>
                    <button onclick="event.stopPropagation(); confirmAndDeleteUser('${oid}', '${user.username}')" class="text-red-600 hover:text-red-800 text-sm">
                        <i class="fas fa-trash mr-1"></i>Delete
                    </button>
                </td>
            </tr>`; 
    });
    tbody.innerHTML = html;
    if (count) count.textContent = users.length;
}

function fetchAllUsers() {
    const tbody = document.getElementById('usersBody');
    if (tbody) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-gray-500">Loading users...</td></tr>';
    }
    fetch('/admin/users')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                allUsers = data.users || [];
                loadUsersIntoTable(allUsers);
            } else {
                loadUsersIntoTable([]);
            }
        })
        .catch(() => loadUsersIntoTable([]));
}

function filterUsers() {
    const q = (document.getElementById('userSearch')?.value || '').toLowerCase();
    if (!q) {
        loadUsersIntoTable(allUsers);
        return;
    }
    const filtered = allUsers.filter(u =>
        (u.username || '').toLowerCase().includes(q) ||
        (u.email || '').toLowerCase().includes(q)
    );
    loadUsersIntoTable(filtered);
}

function closeUsersModal() {
    document.getElementById('usersModal').classList.add('hidden');
}

function viewUserRow(trEl) {
    const id = trEl?.getAttribute('data-user-id');
    if (!id) return;
    viewUserDetails(id);
}

function openUpdateUser(userId, username, email) {
    const container = document.getElementById('userDetailCard');
    if (!container) return;
    container.innerHTML = `
        <div class="fixed top-20 left-1/2 -translate-x-1/2 z-50 w-11/12 md:w-[720px] border border-gray-200 rounded-xl p-5 bg-white shadow-xl">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-semibold text-gray-800">
                    <i class="fas fa-user-edit mr-2 text-[#1e90ff]"></i>Update User
                </h3>
                <button class="text-gray-400 hover:text-gray-600" onclick="closeUserCard()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form onsubmit="submitUpdateUser(event, '${userId}')">
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm text-gray-600 mb-1 block">Username</label>
                        <input id="upd_username" type="text" class="w-full border border-gray-300 rounded-md px-3 py-2" value="${username || ''}" required>
                    </div>
                    <div>
                        <label class="text-sm text-gray-600 mb-1 block">Email</label>
                        <input id="upd_email" type="email" class="w-full border border-gray-300 rounded-md px-3 py-2 break-all" value="${email || ''}" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-sm text-gray-600 mb-1 block">Role</label>
                        <select id="upd_role" class="w-full border border-gray-300 rounded-md px-3 py-2">
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4 flex items-center justify-end space-x-2">
                    <button type="button" onclick="closeUserCard()" class="inline-flex items-center rounded-md bg-gray-100 px-3 py-2 text-sm font-medium text-gray-800 hover:bg-gray-200 transition">Cancel</button>
                    <button type="submit" class="inline-flex items-center rounded-md bg-green-600 px-3 py-2 text-sm font-medium text-white hover:bg-green-700 transition">
                        <i class="fas fa-save mr-2"></i>Save
                    </button>
                </div>
            </form>
        </div>
    `;
}

async function submitUpdateUser(e, userId) {
    e.preventDefault();
    const username = document.getElementById('upd_username')?.value?.trim();
    const email = document.getElementById('upd_email')?.value?.trim();
    const role = document.getElementById('upd_role')?.value || 'user';
    if (!username || !email) {
        showMessageCard('error', 'Username and Email are required');
        return;
    }
    try {
        const res = await fetch(`/admin/user/${userId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, email, role })
        });
        const data = await res.json();
        if (data.success) {
            showMessageCard('success', 'User updated successfully');
            closeUserCard();
            fetchAllUsers();
        } else {
            showMessageCard('error', 'Error updating user: ' + (data.message || 'Unknown error'));
        }
    } catch (err) {
        showMessageCard('error', 'Network error updating user');
    }
}

function viewUserDetails(userId) {
    // Use ObjectId string directly (backend expects MongoDB ObjectId).
    const id = String(userId);
    if (!id) return;
    // Fetch and display user details in a top-fixed card (visible immediately)
    fetch(`/admin/user/${id}`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('userDetailCard');
            if (!container) return;
            if (data.success) {
                const u = data.user || {};
                const joined = u.created_at ? new Date(u.created_at).toLocaleDateString() : '-';
                container.innerHTML = `
                    <div class="fixed top-20 left-1/2 -translate-x-1/2 z-50 w-11/12 md:w-[720px] border border-gray-200 rounded-xl p-5 bg-white shadow-xl">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-gray-800">
                                <i class="fas fa-id-card mr-2 text-[#1e90ff]"></i>User Profile
                            </h3>
                            <button class="text-gray-400 hover:text-gray-600" onclick="closeUserCard()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <div class="text-sm text-gray-500">Username</div>
                                <div class="font-medium text-gray-900">${u.username || '-'}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">Email</div>
                                <div class="font-medium text-gray-900 break-all">${u.email || '-'}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">Predictions</div>
                                <div class="font-medium text-gray-900">${u.prediction_count ?? u.predictions ?? u.count ?? 0}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">Joined</div>
                                <div class="font-medium text-gray-900">${joined}</div>
                            </div>
                        </div>
                        <div class="mt-4 flex items-center justify-end space-x-2">
                            <button onclick="confirmAndDeleteUser('${u._id}', '${u.username}')" class="inline-flex items-center rounded-md bg-gray-900 px-3 py-2 text-sm font-medium text-white hover:bg-black transition">
                                <i class="fas fa-trash mr-2"></i>Delete User
                            </button>
                            <button onclick="closeUserCard()" class="inline-flex items-center rounded-md bg-gray-100 px-3 py-2 text-sm font-medium text-gray-800 hover:bg-gray-200 transition">Close</button>
                        </div>
                    </div>
                `;
                // No scrollIntoView; it's fixed near top-center.
            } else {
                container.innerHTML = `
                    <div class="fixed top-20 left-1/2 -translate-x-1/2 z-50 w-11/12 md:w-[720px] border border-red-200 bg-red-50 text-red-700 px-4 py-3 rounded-lg shadow-xl">
                        Error loading user details
                        <button class="float-right text-red-500" onclick="closeUserCard()"><i class="fas fa-times"></i></button>
                    </div>
                `;
            }
        })
        .catch(() => {
            const container = document.getElementById('userDetailCard');
            if (container) {
                container.innerHTML = `
                    <div class="fixed top-20 left-1/2 -translate-x-1/2 z-50 w-11/12 md:w-[720px] border border-red-200 bg-red-50 text-red-700 px-4 py-3 rounded shadow-xl">
                        Error loading user details
                        <button class="float-right text-red-500" onclick="closeUserCard()"><i class="fas fa-times"></i></button>
                    </div>
                `;
            }
        });
}

function showMessageCard(type, message) {
    // type: 'success' | 'error' | 'info'
    const existing = document.getElementById('adminMessageCard');
    if (existing) existing.remove();
    const bg = type === 'success' ? 'bg-green-50 border-green-200 text-green-800'
             : type === 'error' ? 'bg-red-50 border-red-200 text-red-800'
             : 'bg-blue-50 border-blue-200 text-blue-800';
    const icon = type === 'success' ? 'fa-check-circle'
               : type === 'error' ? 'fa-exclamation-triangle'
               : 'fa-info-circle';
    const wrapper = document.createElement('div');
    wrapper.id = 'adminMessageCard';
    wrapper.innerHTML = `
        <div class="fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-40">
            <div class="w-11/12 md:w-[520px] border rounded-xl p-5 shadow-2xl ${bg}">
                <div class="flex items-start justify-between">
                    <div class="flex items-start space-x-3">
                        <i class="fas ${icon} mt-1"></i>
                        <div class="text-sm">${message}</div>
                    </div>
                    <button class="ml-3 text-gray-500 hover:text-gray-700" onclick="document.getElementById('adminMessageCard')?.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(wrapper);
    // Auto-dismiss after 3s for success/info
    if (type !== 'error') {
        setTimeout(() => document.getElementById('adminMessageCard')?.remove(), 3000);
    }
}

function confirmAndDeleteUser(userId, username) {
    // Custom confirmation component (no native confirm)
    const existing = document.getElementById('adminConfirmCard');
    if (existing) existing.remove();

    const wrapper = document.createElement('div');
    wrapper.id = 'adminConfirmCard';
    wrapper.innerHTML = `
        <div class="fixed inset-0 z-[70] flex items-center justify-center bg-black bg-opacity-40">
            <div class="w-11/12 md:w-[520px] border border-gray-200 rounded-xl p-5 bg-white shadow-2xl">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-user-times mr-2 text-red-600"></i>Delete User
                    </h3>
                    <button class="text-gray-400 hover:text-gray-600" onclick="document.getElementById('adminConfirmCard')?.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="text-sm text-gray-700 mb-4">
                    Are you sure you want to delete user "<span class="font-semibold">${username}</span>"? This action cannot be undone.
                </div>
                <div class="flex items-center justify-end space-x-2">
                    <button class="inline-flex items-center rounded-md bg-gray-100 px-3 py-2 text-sm font-medium text-gray-800 hover:bg-gray-200 transition" onclick="document.getElementById('adminConfirmCard')?.remove()">Cancel</button>
                    <button class="inline-flex items-center rounded-md bg-red-600 px-3 py-2 text-sm font-medium text-white hover:bg-red-700 transition" onclick="performDeleteUser('${userId}')">
                        <i class="fas fa-trash mr-2"></i>Delete
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(wrapper);
}

function performDeleteUser(userId) {
    const card = document.getElementById('adminConfirmCard');
    if (card) card.querySelectorAll('button').forEach(b => b.disabled = true);

    fetch(`/admin/user/${userId}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('adminConfirmCard')?.remove();
        if (data.success) {
            showMessageCard('success', 'User deleted successfully');
            fetchAllUsers();
        } else {
            showMessageCard('error', 'Error deleting user: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(() => {
        document.getElementById('adminConfirmCard')?.remove();
        showMessageCard('error', 'Error deleting user');
    });
}

function exportUsers() {
    // Export users to CSV
    fetch('/admin/export/users')
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'users_export.csv';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        })
        .catch(error => {
            alert('Error exporting users');
        });
}

function viewAnalytics() {
    // No-op: charts below already load automatically via drawAnalyticsChart()
}

// Predictions page helpers
function loadPredictions(page = 1) {
    const body = document.getElementById('predictionsBody');
    const countEl = document.getElementById('predCount');
    const pageEl = document.getElementById('predPage');
    if (body) body.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-gray-500">Loading predictions...</td></tr>';
    fetch(`/admin/predictions?page=${page}&page_size=${predPageSize}`)
        .then(r => r.json())
        .then(data => {
            if (!data.success) throw new Error(data.message || 'Failed');
            allPredictions = data.items || [];
            if (countEl) countEl.textContent = data.total ?? allPredictions.length;
            if (pageEl) pageEl.textContent = data.page ?? page;
            renderPredictions(allPredictions);
        })
        .catch(() => {
            if (body) body.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-red-600">Error loading predictions</td></tr>';
        });
}

function renderPredictions(items) {
    const body = document.getElementById('predictionsBody');
    if (!body) return;
    if (!items || items.length === 0) {
        body.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-gray-500">No predictions</td></tr>';
        return;
    }
    let html = '';
    items.forEach(p => {
        const dateStr = p.created_at ? new Date(p.created_at).toLocaleString() : '-';
        const spec = `${p.year} | ${p.engine_size}L | MPG ${p.mpg} | ${p.transmission}`;
        html += `
            <tr class="border-b hover:bg-blue-50">
                <td class="px-4 py-3 font-medium text-gray-800">${p.username || '-'}</td>
                <td class="px-4 py-3">${dateStr}</td>
                <td class="px-4 py-3 text-sm text-gray-700">${spec}</td>
                <td class="px-4 py-3 font-semibold text-green-700">$${(p.predicted_price ?? 0).toFixed(2)}</td>
                <td class="px-4 py-3 space-x-2">
                    <button class="text-red-600 hover:text-red-800 text-sm" onclick="confirmAndDeletePrediction('${p._id}')"><i class="fas fa-trash mr-1"></i>Delete</button>
                    <button class="text-gray-700 hover:text-black text-sm" onclick="viewPredictionDetail('${p._id}')"><i class="fas fa-eye mr-1"></i>View</button>
                </td>
            </tr>`;
    });
    body.innerHTML = html;
}

function filterPredictions() {
    const q = (document.getElementById('predSearch')?.value || '').toLowerCase();
    if (!q) {
        renderPredictions(allPredictions);
        return;
    }
    const filtered = allPredictions.filter(p => (p.username || '').toLowerCase().includes(q));
    renderPredictions(filtered);
}

function prevPredPage() {
    if (predPage > 1) {
        predPage -= 1;
        loadPredictions(predPage);
    }
}

function nextPredPage() {
    predPage += 1;
    loadPredictions(predPage);
}

function confirmAndDeletePrediction(id) {
    // Custom confirmation modal for prediction deletion
    const existing = document.getElementById('adminConfirmCard');
    if (existing) existing.remove();

    const wrapper = document.createElement('div');
    wrapper.id = 'adminConfirmCard';
    wrapper.innerHTML = `
        <div class="fixed inset-0 z-[70] flex items-center justify-center bg-black bg-opacity-40">
            <div class="w-11/12 md:w-[520px] border border-gray-200 rounded-xl p-5 bg-white shadow-2xl">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-trash mr-2 text-red-600"></i>Delete Prediction
                    </h3>
                    <button class="text-gray-400 hover:text-gray-600" onclick="document.getElementById('adminConfirmCard')?.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="text-sm text-gray-700 mb-4">
                    Are you sure you want to delete this prediction? This action cannot be undone.
                </div>
                <div class="flex items-center justify-end space-x-2">
                    <button class="inline-flex items-center rounded-md bg-gray-100 px-3 py-2 text-sm font-medium text-gray-800 hover:bg-gray-200 transition" onclick="document.getElementById('adminConfirmCard')?.remove()">Cancel</button>
                    <button class="inline-flex items-center rounded-md bg-red-600 px-3 py-2 text-sm font-medium text-white hover:bg-red-700 transition" onclick="performDeletePrediction('${id}')">
                        <i class="fas fa-trash mr-2"></i>Delete
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(wrapper);
}

function performDeletePrediction(id) {
    const card = document.getElementById('adminConfirmCard');
    if (card) card.querySelectorAll('button').forEach(b => b.disabled = true);

    fetch(`/admin/predictions/${id}`, { method: 'DELETE' })
        .then(r => r.json())
        .then(data => {
            document.getElementById('adminConfirmCard')?.remove();
            if (data.success) {
                showMessageCard('success', 'Prediction deleted successfully');
                loadPredictions(predPage);
            } else {
                showMessageCard('error', 'Error deleting prediction: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(() => {
            document.getElementById('adminConfirmCard')?.remove();
            showMessageCard('error', 'Error deleting prediction');
        });
}

function viewPredictionDetail(id) {
    const p = allPredictions.find(x => x._id === id);
    if (!p) return;
    const card = document.getElementById('predDetailCard');
    if (!card) return;
    card.innerHTML = `
        <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40">
            <div class="w-11/12 md:w-[720px] max-w-[720px] border border-gray-200 rounded-xl p-5 bg-white shadow-xl">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-file-alt mr-2 text-[#1e90ff]"></i>Prediction Detail
                    </h3>
                    <button class="text-gray-400 hover:text-gray-600" onclick="document.getElementById('predDetailCard').innerHTML=''">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="grid md:grid-cols-2 gap-4">
                    <div><div class="text-sm text-gray-500">User</div><div class="font-medium text-gray-900">${p.username || '-'}</div></div>
                    <div><div class="text-sm text-gray-500">Date</div><div class="font-medium text-gray-900">${p.created_at ? new Date(p.created_at).toLocaleString() : '-'}</div></div>
                    <div><div class="text-sm text-gray-500">Year</div><div class="font-medium text-gray-900">${p.year}</div></div>
                    <div><div class="text-sm text-gray-500">Engine</div><div class="font-medium text-gray-900">${p.engine_size} L</div></div>
                    <div><div class="text-sm text-gray-500">Mileage</div><div class="font-medium text-gray-900">${p.mileage}</div></div>
                    <div><div class="text-sm text-gray-500">MPG</div><div class="font-medium text-gray-900">${p.mpg}</div></div>
                    <div><div class="text-sm text-gray-500">Transmission</div><div class="font-medium text-gray-900">${p.transmission}</div></div>
                    <div><div class="text-sm text-gray-500">Predicted Price</div><div class="font-medium text-green-700">$${(p.predicted_price ?? 0).toFixed(2)}</div></div>
                </div>
                <div class="mt-4 flex items-center justify-end">
                    <button class="inline-flex items-center rounded-md bg-gray-100 px-3 py-2 text-sm font-medium text-gray-800 hover:bg-gray-200 transition" onclick="document.getElementById('predDetailCard').innerHTML=''">Close</button>
                </div>
            </div>
        </div>
    `;
}

function exportReports() {
    // Export predictions report
    fetch('/admin/export/predictions')
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'predictions_report.csv';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        })
        .catch(error => {
            alert('Error exporting reports');
        });
}

function testModel() {
    // Test the model and show result in a centered message card (no alert)
    fetch('/test_model')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const msg = `Model Type: ${data.model_type}<br/>Predicted Price: $${data.predicted_price}<br/>${data.message}`;
                showMessageCard('success', msg);
            } else {
                showMessageCard('error', data.message || 'Model test failed');
            }
        })
        .catch(err => {
            showMessageCard('error', 'Error testing model: ' + err);
        });
}

/* settings removed */

function viewAllPredictions() {
    alert('All predictions view would be implemented here');
}

function changeChartPeriod(period) {
    // Update chart buttons visual state
    document.querySelectorAll('[onclick^="changeChartPeriod"]').forEach(btn => {
        btn.className = 'px-3 py-1 rounded-md text-sm bg-gray-100 text-gray-700 hover:bg-gray-200 transition';
    });
    if (event && event.target) {
        event.target.className = 'px-3 py-1 rounded-md text-sm bg-green-600 text-white hover:bg-green-700 transition';
    }
    drawAnalyticsChart();
}

function drawAnalyticsChart() {
    // Fetch real data for both charts
    fetch('/admin/reports/summary')
        .then(r => r.json())
        .then(report => {
            const labels = report.success ? report.labels : ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
            const predictions = report.success ? report.predictions : [12,19,8,15,22,18,25];
            const users = report.success ? report.new_users : [3,5,2,4,7,6,8];

            // Chart 1: Overview trends (line)
            const c1 = document.getElementById('analyticsChart');
            if (c1) {
                const ctx = c1.getContext('2d');
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                const width = ctx.canvas.width;
                const height = ctx.canvas.height;
                const maxValue = Math.max(...predictions, ...users) || 1;

                // Predictions line (green)
                ctx.beginPath();
                ctx.strokeStyle = '#16a34a';
                ctx.lineWidth = 3;
                for (let i = 0; i < predictions.length; i++) {
                    const x = (i / (predictions.length - 1)) * (width - 100) + 50;
                    const y = height - 50 - ((predictions[i] / maxValue) * (height - 100));
                    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                }
                ctx.stroke();

                // Users line (gray)
                ctx.beginPath();
                ctx.strokeStyle = '#6B7280';
                ctx.lineWidth = 3;
                for (let i = 0; i < users.length; i++) {
                    const x = (i / (users.length - 1)) * (width - 100) + 50;
                    const y = height - 50 - ((users[i] / maxValue) * (height - 100));
                    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                }
                ctx.stroke();

                // X labels
                ctx.fillStyle = '#6B7280';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                for (let i = 0; i < labels.length; i++) {
                    const x = (i / (labels.length - 1)) * (width - 100) + 50;
                    ctx.fillText(labels[i], x, height - 20);
                }

                // Legend
                ctx.fillStyle = '#16a34a';
                ctx.fillRect(width - 150, 20, 15, 3);
                ctx.fillStyle = '#374151';
                ctx.font = '12px Arial';
                ctx.textAlign = 'left';
                ctx.fillText('Predictions', width - 130, 25);

                ctx.fillStyle = '#6B7280';
                ctx.fillRect(width - 150, 40, 15, 3);
                ctx.fillStyle = '#374151';
                ctx.fillText('New Users', width - 130, 45);
            }

            // Chart 2: Reports bar chart
            const c2 = document.getElementById('analyticsChart2');
            if (c2) {
                const ctx2 = c2.getContext('2d');
                ctx2.clearRect(0, 0, ctx2.canvas.width, ctx2.canvas.height);
                const width = ctx2.canvas.width;
                const height = ctx2.canvas.height;
                const maxValue = Math.max(...predictions) || 1;
                const chartWidth = width - 100;
                const barWidth = chartWidth / predictions.length - 10;

                for (let i = 0; i < predictions.length; i++) {
                    const x = 50 + i * (barWidth + 10);
                    const h = ((predictions[i] / maxValue) * (height - 100));
                    const y = height - 50 - h;
                    // Bar
                    ctx2.fillStyle = '#16a34a';
                    ctx2.fillRect(x, y, barWidth, h);
                    // Label
                    ctx2.fillStyle = '#6B7280';
                    ctx2.font = '12px Arial';
                    ctx2.textAlign = 'center';
                    ctx2.fillText(labels[i], x + barWidth / 2, height - 20);
                }
            }
        })
        .catch(() => {
            // If API fails, fall back to existing sample rendering
            const c1 = document.getElementById('analyticsChart');
            if (c1) {
                const ctx = c1.getContext('2d');
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                const labels = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
                const predictions = [12,19,8,15,22,18,25];
                const users = [3,5,2,4,7,6,8];
                const width = ctx.canvas.width;
                const height = ctx.canvas.height;
                const maxValue = Math.max(...predictions, ...users) || 1;

                ctx.beginPath();
                ctx.strokeStyle = '#16a34a';
                ctx.lineWidth = 3;
                for (let i = 0; i < predictions.length; i++) {
                    const x = (i / (predictions.length - 1)) * (width - 100) + 50;
                    const y = height - 50 - ((predictions[i] / maxValue) * (height - 100));
                    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                }
                ctx.stroke();

                ctx.beginPath();
                ctx.strokeStyle = '#6B7280';
                ctx.lineWidth = 3;
                for (let i = 0; i < users.length; i++) {
                    const x = (i / (users.length - 1)) * (width - 100) + 50;
                    const y = height - 50 - ((users[i] / maxValue) * (height - 100));
                    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                }
                ctx.stroke();

                ctx.fillStyle = '#6B7280';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                for (let i = 0; i < labels.length; i++) {
                    const x = (i / (labels.length - 1)) * (width - 100) + 50;
                    ctx.fillText(labels[i], x, height - 20);
                }
            }
        });
}

function activateSection(id) {
    // Hide all sections
    document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
    // Show selected
    const el = document.getElementById('section-' + id);
    if (el) el.classList.remove('hidden');
    // Update sidebar active state
    document.querySelectorAll('.sidebar-link').forEach(btn => {
        btn.classList.remove('bg-blue-600/30', 'text-white');
    });
    const activeBtn = document.querySelector(`.sidebar-link[data-target="${id}"]`);
    if (activeBtn) {
        activeBtn.classList.add('bg-blue-600/30', 'text-white');
    }
}

function closeUserCard() {
    const c = document.getElementById('userDetailCard');
    if (c) c.innerHTML = '';
}

document.addEventListener('DOMContentLoaded', function() {
    // Sidebar navigation
    document.querySelectorAll('.sidebar-link').forEach(btn => {
        btn.addEventListener('click', () => {
            activateSection(btn.dataset.target);
            if (btn.dataset.target === 'users') {
                fetchAllUsers();
            } else if (btn.dataset.target === 'predictions') {
                predPage = 1;
                loadPredictions(predPage);
                        } else if (btn.dataset.target === 'analytics') {
                drawAnalyticsChart();
            }
        });
    });

    // Ensure overview content is visible initially and marked active
    activateSection('overview');

    // Load initial data
    fetchAllUsers();
    drawAnalyticsChart();
    
    // Auto-refresh data every 3 seconds when on analytics page
    setInterval(() => {
        const analyticsSection = document.getElementById('section-analytics');
        const isAnalyticsVisible = analyticsSection && !analyticsSection.classList.contains('hidden');
        
        if (isAnalyticsVisible) {
            console.log('Auto-refreshing analytics data...');
            drawAnalyticsChart();
        }
    }, 3000); // 3 seconds for faster updates
});

// Visualization Functions
let currentVisualizationType = 'price-distribution';
let liveModeEnabled = false;
let liveModeInterval = null;

function changeVisualizationType(type) {
    currentVisualizationType = type;
    
    // Update button states
    document.querySelectorAll('[onclick^="changeVisualizationType"]').forEach(btn => {
        btn.className = 'px-4 py-2 rounded-lg text-sm bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors font-medium';
    });
    event.target.className = 'px-4 py-2 rounded-lg text-sm bg-blue-600 text-white hover:bg-blue-700 transition-colors font-medium';
    
    // Load new visualization
    loadVisualizationData();
}

function loadVisualizationData() {
    // Fetch real prediction data for visualization
    fetch('/admin/predictions/data')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.predictions && data.predictions.length > 0) {
                updateVisualizationCharts(data.predictions);
                updateVisualizationStats(data.stats);
                console.log('Visualization data loaded:', data.predictions.length, 'predictions');
            } else {
                // Show no data message instead of sample data
                showNoDataMessage();
                console.log('No prediction data available');
            }
        })
        .catch((error) => {
            console.error('Error loading visualization data:', error);
            // Show error message instead of sample data
            showNoDataMessage();
        });
}

function refreshVisualizationData() {
    console.log('Manual refresh triggered...');
    
    // Show loading state
    const refreshBtn = event.target;
    const originalText = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
    refreshBtn.disabled = true;
    
    // Force reload with cache busting
    fetch('/admin/predictions/data?t=' + Date.now())
        .then(response => response.json())
        .then(data => {
            console.log('Refresh response:', data);
            if (data.success && data.predictions && data.predictions.length > 0) {
                updateVisualizationCharts(data.predictions);
                updateVisualizationStats(data.stats);
                console.log('Visualization refreshed:', data.predictions.length, 'predictions');
                showSuccessNotification('Visualization data refreshed successfully!');
            } else {
                showNoDataMessage();
                console.log('No prediction data available after refresh');
                showInfoNotification('No prediction data available');
            }
        })
        .catch((error) => {
            console.error('Error refreshing visualization data:', error);
            showNoDataMessage();
            showErrorNotification('Error loading data');
        })
        .finally(() => {
            // Restore button
            refreshBtn.innerHTML = originalText;
            refreshBtn.disabled = false;
        });
}

function refreshAnalyticsData() {
    console.log('Analytics refresh triggered...');
    
    // Show loading state
    const refreshBtn = event.target;
    const originalText = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
    refreshBtn.disabled = true;
    
    // Refresh analytics chart
    drawAnalyticsChart();
    
    // Also refresh recent predictions in overview
    fetch('/admin/predictions/data?t=' + Date.now())
        .then(response => response.json())
        .then(data => {
            if (data.success && data.predictions && data.predictions.length > 0) {
                console.log('Analytics refreshed:', data.predictions.length, 'predictions');
                showSuccessNotification('Analytics data refreshed successfully!');
            } else {
                showInfoNotification('No prediction data available');
            }
        })
        .catch((error) => {
            console.error('Error refreshing analytics data:', error);
            showErrorNotification('Error loading analytics data');
        })
        .finally(() => {
            // Restore button
            refreshBtn.innerHTML = originalText;
            refreshBtn.disabled = false;
        });
}

function showNoDataMessage() {
    // Clear charts and show no data message
    const mainChart = document.getElementById('mainVisualizationChart');
    const secondaryChart = document.getElementById('secondaryVisualizationChart');
    
    if (mainChart) {
        const ctx = mainChart.getContext('2d');
        ctx.clearRect(0, 0, mainChart.width, mainChart.height);
        
        // Draw no data message
        ctx.fillStyle = '#6B7280';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('No prediction data available', mainChart.width / 2, mainChart.height / 2 - 10);
        ctx.font = '14px Arial';
        ctx.fillText('Make some predictions to see visualizations', mainChart.width / 2, mainChart.height / 2 + 10);
    }
    
    if (secondaryChart) {
        const ctx = secondaryChart.getContext('2d');
        ctx.clearRect(0, 0, secondaryChart.width, secondaryChart.height);
        
        // Draw no data message
        ctx.fillStyle = '#6B7280';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('No prediction data available', secondaryChart.width / 2, secondaryChart.height / 2 - 10);
        ctx.font = '14px Arial';
        ctx.fillText('Make some predictions to see visualizations', secondaryChart.width / 2, secondaryChart.height / 2 + 10);
    }
    
    // Update stats to show zeros
    document.getElementById('avgPrice').textContent = '$0';
    document.getElementById('totalPredictions').textContent = '0';
    document.getElementById('activeUsers').textContent = '0';
    document.getElementById('modelAccuracy').textContent = '0%';
}

function updateVisualizationCharts(predictions) {
    switch(currentVisualizationType) {
        case 'price-distribution':
            drawPriceDistributionChart(predictions);
            drawPriceTrendsChart(predictions);
            break;
        case 'prediction-trends':
            drawPredictionTrendsChart(predictions);
            drawUserActivityChart(predictions);
            break;
        case 'user-activity':
            drawUserActivityChart(predictions);
            drawPriceDistributionChart(predictions);
            break;
        case 'model-performance':
            drawModelPerformanceChart(predictions);
            drawAccuracyTrendsChart(predictions);
            break;
        case 'fuel-analysis':
            drawFuelAnalysisChart(predictions);
            drawMileageAnalysisChart(predictions);
            break;
    }
}

function updateVisualizationStats(stats) {
    document.getElementById('avgPrice').textContent = '$' + stats.avgPrice.toLocaleString();
    document.getElementById('totalPredictions').textContent = stats.totalPredictions;
    document.getElementById('activeUsers').textContent = stats.activeUsers;
    document.getElementById('modelAccuracy').textContent = stats.modelAccuracy + '%';
    
    // Show notification for new data
    showDataUpdateNotification(stats.totalPredictions);
}

function showDataUpdateNotification(predictionCount) {
    showSuccessNotification(`Data updated: ${predictionCount} predictions loaded`);
}

function showSuccessNotification(message) {
    showNotification(message, 'bg-green-500', 'fa-check-circle');
}

function showErrorNotification(message) {
    showNotification(message, 'bg-red-500', 'fa-exclamation-circle');
}

function showInfoNotification(message) {
    showNotification(message, 'bg-blue-500', 'fa-info-circle');
}

function showNotification(message, bgColor, iconClass) {
    // Remove existing notification
    const existingNotification = document.getElementById('dataUpdateNotification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    // Create new notification
    const notification = document.createElement('div');
    notification.id = 'dataUpdateNotification';
    notification.className = `fixed top-20 right-4 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full`;
    
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${iconClass} mr-2"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Show notification
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);
    
    // Hide after 3 seconds
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 300);
    }, 3000);
}

function drawPriceDistributionChart(predictions) {
    const canvas = document.getElementById('mainVisualizationChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Check if we have real data
    if (!predictions || predictions.length === 0) {
        showNoDataMessage();
        return;
    }
    
    // Group prices into ranges
    const priceRanges = {
        '0-10k': 0, '10k-20k': 0, '20k-30k': 0, '30k-40k': 0, '40k+': 0
    };
    
    predictions.forEach(pred => {
        const price = pred.predicted_price;
        if (price < 10000) priceRanges['0-10k']++;
        else if (price < 20000) priceRanges['10k-20k']++;
        else if (price < 30000) priceRanges['20k-30k']++;
        else if (price < 40000) priceRanges['30k-40k']++;
        else priceRanges['40k+']++;
    });
    
    const labels = Object.keys(priceRanges);
    const values = Object.values(priceRanges);
    const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'];
    
    const width = canvas.width;
    const height = canvas.height;
    const maxValue = Math.max(...values) || 1;
    
    // Draw bars
    const barWidth = (width - 100) / labels.length;
    for (let i = 0; i < labels.length; i++) {
        const x = 50 + i * barWidth;
        const barHeight = (values[i] / maxValue) * (height - 100);
        const y = height - 50 - barHeight;
        
        // Bar
        ctx.fillStyle = colors[i];
        ctx.fillRect(x, y, barWidth - 10, barHeight);
        
        // Label
        ctx.fillStyle = '#374151';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(labels[i], x + barWidth/2 - 5, height - 20);
        
        // Value
        ctx.fillText(values[i], x + barWidth/2 - 5, y - 10);
    }
}

function drawPriceTrendsChart(predictions) {
    const canvas = document.getElementById('secondaryVisualizationChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Check if we have real data
    if (!predictions || predictions.length === 0) {
        showNoDataMessage();
        return;
    }
    
    // Sort by year
    const sortedPredictions = predictions.sort((a, b) => a.year - b.year);
    const years = [...new Set(sortedPredictions.map(p => p.year))];
    const avgPrices = years.map(year => {
        const yearPreds = sortedPredictions.filter(p => p.year === year);
        return yearPreds.reduce((sum, p) => sum + p.predicted_price, 0) / yearPreds.length;
    });
    
    const width = canvas.width;
    const height = canvas.height;
    const maxPrice = Math.max(...avgPrices) || 1;
    
    // Draw line
    ctx.beginPath();
    ctx.strokeStyle = '#10B981';
    ctx.lineWidth = 3;
    
    for (let i = 0; i < years.length; i++) {
        const x = 50 + (i / (years.length - 1)) * (width - 100);
        const y = height - 50 - ((avgPrices[i] / maxPrice) * (height - 100));
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    }
    ctx.stroke();
    
    // Draw points
    for (let i = 0; i < years.length; i++) {
        const x = 50 + (i / (years.length - 1)) * (width - 100);
        const y = height - 50 - ((avgPrices[i] / maxPrice) * (height - 100));
        
        ctx.fillStyle = '#10B981';
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, 2 * Math.PI);
        ctx.fill();
        
        // Year label
        ctx.fillStyle = '#374151';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(years[i], x, height - 20);
    }
}

function drawPredictionTrendsChart(predictions) {
    const canvas = document.getElementById('mainVisualizationChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Check if we have real data
    if (!predictions || predictions.length === 0) {
        showNoDataMessage();
        return;
    }
    
    // Group by transmission type
    const transmissionData = {};
    predictions.forEach(pred => {
        const trans = pred.transmission;
        if (!transmissionData[trans]) transmissionData[trans] = 0;
        transmissionData[trans]++;
    });
    
    const labels = Object.keys(transmissionData);
    const values = Object.values(transmissionData);
    const colors = ['#3B82F6', '#10B981'];
    
    const width = canvas.width;
    const height = canvas.height;
    const centerX = width / 2;
    const centerY = height / 2;
    const radius = Math.min(width, height) / 3;
    
    const total = values.reduce((sum, val) => sum + val, 0);
    
    let currentAngle = 0;
    for (let i = 0; i < labels.length; i++) {
        const sliceAngle = (values[i] / total) * 2 * Math.PI;
        
        // Draw slice
        ctx.fillStyle = colors[i];
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
        ctx.closePath();
        ctx.fill();
        
        // Label
        const labelAngle = currentAngle + sliceAngle / 2;
        const labelX = centerX + Math.cos(labelAngle) * (radius + 30);
        const labelY = centerY + Math.sin(labelAngle) * (radius + 30);
        
        ctx.fillStyle = '#374151';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(labels[i], labelX, labelY);
        ctx.fillText(values[i], labelX, labelY + 20);
        
        currentAngle += sliceAngle;
    }
}

function drawUserActivityChart(predictions) {
    const canvas = document.getElementById('secondaryVisualizationChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Check if we have real data
    if (!predictions || predictions.length === 0) {
        showNoDataMessage();
        return;
    }
    
    // Group predictions by month from real data
    const monthlyData = {};
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    
    predictions.forEach(pred => {
        let date;
        if (typeof pred.created_at === 'string') {
            date = new Date(pred.created_at);
        } else {
            date = pred.created_at;
        }
        const month = date.getMonth();
        const monthName = months[month];
        
        if (!monthlyData[monthName]) {
            monthlyData[monthName] = 0;
        }
        monthlyData[monthName]++;
    });
    
    // Fill in missing months with 0
    months.forEach(month => {
        if (!monthlyData[month]) {
            monthlyData[month] = 0;
        }
    });
    
    const activityData = months.map(month => monthlyData[month]);
    
    const width = canvas.width;
    const height = canvas.height;
    const maxValue = Math.max(...activityData) || 1;
    
    // Draw bars
    const barWidth = (width - 100) / activityData.length;
    for (let i = 0; i < activityData.length; i++) {
        const x = 50 + i * barWidth;
        const barHeight = (activityData[i] / maxValue) * (height - 100);
        const y = height - 50 - barHeight;
        
        // Bar
        ctx.fillStyle = '#8B5CF6';
        ctx.fillRect(x, y, barWidth - 5, barHeight);
        
        // Month label
        ctx.fillStyle = '#374151';
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(months[i], x + barWidth/2 - 2.5, height - 20);
    }
}

function drawModelPerformanceChart(predictions) {
    const canvas = document.getElementById('mainVisualizationChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Check if we have real data
    if (!predictions || predictions.length === 0) {
        showNoDataMessage();
        return;
    }
    
    // Calculate real model performance metrics from prediction data
    const prices = predictions.map(p => p.predicted_price);
    const avgPrice = prices.reduce((sum, price) => sum + price, 0) / prices.length;
    const priceVariance = prices.reduce((sum, price) => sum + Math.pow(price - avgPrice, 2), 0) / prices.length;
    const priceStdDev = Math.sqrt(priceVariance);
    
    // Calculate metrics based on real data
    const totalPredictions = predictions.length;
    const uniqueUsers = new Set(predictions.map(p => p.username)).size;
    const avgAccuracy = Math.max(85, Math.min(95, 92 - (priceVariance / 1000000)));
    
    const metrics = {
        'Total Predictions': totalPredictions,
        'Unique Users': uniqueUsers,
        'Avg Price': Math.round(avgPrice),
        'Price Std Dev': Math.round(priceStdDev)
    };
    
    const labels = Object.keys(metrics);
    const values = Object.values(metrics);
    const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444'];
    
    const width = canvas.width;
    const height = canvas.height;
    const maxValue = 100;
    
    // Draw horizontal bars
    const barHeight = 30;
    const spacing = 20;
    const startY = 50;
    
    for (let i = 0; i < labels.length; i++) {
        const y = startY + i * (barHeight + spacing);
        const barWidth = (values[i] / maxValue) * (width - 150);
        
        // Background bar
        ctx.fillStyle = '#E5E7EB';
        ctx.fillRect(100, y, width - 150, barHeight);
        
        // Value bar
        ctx.fillStyle = colors[i];
        ctx.fillRect(100, y, barWidth, barHeight);
        
        // Label
        ctx.fillStyle = '#374151';
        ctx.font = '14px Arial';
        ctx.textAlign = 'left';
        ctx.fillText(labels[i], 10, y + 20);
        
        // Value
        ctx.textAlign = 'right';
        ctx.fillText(values[i] + '%', width - 20, y + 20);
    }
}

function drawAccuracyTrendsChart(predictions) {
    const canvas = document.getElementById('secondaryVisualizationChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Check if we have real data
    if (!predictions || predictions.length === 0) {
        showNoDataMessage();
        return;
    }
    
    // Calculate real accuracy trends from prediction data
    const monthlyAccuracy = {};
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    
    predictions.forEach(pred => {
        let date;
        if (typeof pred.created_at === 'string') {
            date = new Date(pred.created_at);
        } else {
            date = pred.created_at;
        }
        const month = date.getMonth();
        const monthName = months[month];
        
        if (!monthlyAccuracy[monthName]) {
            monthlyAccuracy[monthName] = { prices: [], count: 0 };
        }
        monthlyAccuracy[monthName].prices.push(pred.predicted_price);
        monthlyAccuracy[monthName].count++;
    });
    
    // Calculate accuracy based on price variance for each month
    const accuracyData = months.map(month => {
        const monthData = monthlyAccuracy[month];
        if (!monthData || monthData.count === 0) return 85; // Default accuracy
        
        const avgPrice = monthData.prices.reduce((sum, price) => sum + price, 0) / monthData.prices.length;
        const variance = monthData.prices.reduce((sum, price) => sum + Math.pow(price - avgPrice, 2), 0) / monthData.prices.length;
        
        // Lower variance = higher accuracy (simplified calculation)
        return Math.max(85, Math.min(95, 92 - (variance / 1000000)));
    });
    
    const width = canvas.width;
    const height = canvas.height;
    
    // Draw line
    ctx.beginPath();
    ctx.strokeStyle = '#EF4444';
    ctx.lineWidth = 3;
    
    for (let i = 0; i < accuracyData.length; i++) {
        const x = 50 + (i / (accuracyData.length - 1)) * (width - 100);
        const y = height - 50 - ((accuracyData[i] / 100) * (height - 100));
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    }
    ctx.stroke();
    
    // Draw points and labels
    for (let i = 0; i < accuracyData.length; i++) {
        const x = 50 + (i / (accuracyData.length - 1)) * (width - 100);
        const y = height - 50 - ((accuracyData[i] / 100) * (height - 100));
        
        ctx.fillStyle = '#EF4444';
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, 2 * Math.PI);
        ctx.fill();
        
        // Month label
        if (i % 2 === 0) {
            ctx.fillStyle = '#374151';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(months[i], x, height - 20);
        }
    }
}

function drawFuelAnalysisChart(predictions) {
    const canvas = document.getElementById('mainVisualizationChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Check if we have real data
    if (!predictions || predictions.length === 0) {
        showNoDataMessage();
        return;
    }
    
    // Group by fuel type and calculate average price
    const fuelData = {};
    predictions.forEach(pred => {
        const fuelType = pred.fuel_type || 'Petrol';
        if (!fuelData[fuelType]) {
            fuelData[fuelType] = { count: 0, totalPrice: 0 };
        }
        fuelData[fuelType].count++;
        fuelData[fuelType].totalPrice += pred.predicted_price;
    });
    
    // Calculate average prices
    const fuelTypes = Object.keys(fuelData);
    const avgPrices = fuelTypes.map(fuel => fuelData[fuel].totalPrice / fuelData[fuel].count);
    const counts = fuelTypes.map(fuel => fuelData[fuel].count);
    
    const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'];
    
    const width = canvas.width;
    const height = canvas.height;
    const maxPrice = Math.max(...avgPrices) || 1;
    
    // Draw bars
    const barWidth = (width - 100) / fuelTypes.length;
    for (let i = 0; i < fuelTypes.length; i++) {
        const x = 50 + i * barWidth;
        const barHeight = (avgPrices[i] / maxPrice) * (height - 120);
        const y = height - 80 - barHeight;
        
        // Bar
        ctx.fillStyle = colors[i % colors.length];
        ctx.fillRect(x, y, barWidth - 10, barHeight);
        
        // Fuel type label
        ctx.fillStyle = '#374151';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(fuelTypes[i], x + barWidth/2 - 5, height - 40);
        
        // Average price
        ctx.fillText('$' + Math.round(avgPrices[i]).toLocaleString(), x + barWidth/2 - 5, height - 20);
        
        // Count
        ctx.fillText('(' + counts[i] + ' cars)', x + barWidth/2 - 5, y - 10);
    }
}

function drawMileageAnalysisChart(predictions) {
    const canvas = document.getElementById('secondaryVisualizationChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Check if we have real data
    if (!predictions || predictions.length === 0) {
        showNoDataMessage();
        return;
    }
    
    // Group mileage into ranges
    const mileageRanges = {
        '0-20k': { count: 0, totalPrice: 0 },
        '20k-40k': { count: 0, totalPrice: 0 },
        '40k-60k': { count: 0, totalPrice: 0 },
        '60k-80k': { count: 0, totalPrice: 0 },
        '80k+': { count: 0, totalPrice: 0 }
    };
    
    predictions.forEach(pred => {
        const mileage = pred.mileage || 0;
        if (mileage < 20000) {
            mileageRanges['0-20k'].count++;
            mileageRanges['0-20k'].totalPrice += pred.predicted_price;
        } else if (mileage < 40000) {
            mileageRanges['20k-40k'].count++;
            mileageRanges['20k-40k'].totalPrice += pred.predicted_price;
        } else if (mileage < 60000) {
            mileageRanges['40k-60k'].count++;
            mileageRanges['40k-60k'].totalPrice += pred.predicted_price;
        } else if (mileage < 80000) {
            mileageRanges['60k-80k'].count++;
            mileageRanges['60k-80k'].totalPrice += pred.predicted_price;
        } else {
            mileageRanges['80k+'].count++;
            mileageRanges['80k+'].totalPrice += pred.predicted_price;
        }
    });
    
    const ranges = Object.keys(mileageRanges);
    const avgPrices = ranges.map(range => {
        const data = mileageRanges[range];
        return data.count > 0 ? data.totalPrice / data.count : 0;
    });
    
    const width = canvas.width;
    const height = canvas.height;
    const maxPrice = Math.max(...avgPrices) || 1;
    
    // Draw line chart
    ctx.beginPath();
    ctx.strokeStyle = '#8B5CF6';
    ctx.lineWidth = 3;
    
    for (let i = 0; i < ranges.length; i++) {
        const x = 50 + (i / (ranges.length - 1)) * (width - 100);
        const y = height - 50 - ((avgPrices[i] / maxPrice) * (height - 100));
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    }
    ctx.stroke();
    
    // Draw points and labels
    for (let i = 0; i < ranges.length; i++) {
        const x = 50 + (i / (ranges.length - 1)) * (width - 100);
        const y = height - 50 - ((avgPrices[i] / maxPrice) * (height - 100));
        
        ctx.fillStyle = '#8B5CF6';
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, 2 * Math.PI);
        ctx.fill();
        
        // Range label
        ctx.fillStyle = '#374151';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(ranges[i], x, height - 20);
        
        // Price label
        if (avgPrices[i] > 0) {
            ctx.fillText('$' + Math.round(avgPrices[i]).toLocaleString(), x, y - 15);
        }
    }
}

function forceRefreshAllData() {
    console.log('Force refreshing all data...');
    
    // Show loading state
    const refreshBtn = event.target;
    const originalText = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Refreshing...';
    refreshBtn.disabled = true;
    
    // Refresh both visualization and analytics
    Promise.all([
        // Refresh visualization data
        fetch('/admin/predictions/data?t=' + Date.now()).then(r => r.json()),
        // Refresh analytics
        new Promise(resolve => {
            drawAnalyticsChart();
            resolve({ success: true });
        })
    ])
    .then(([visualizationData, analyticsData]) => {
        if (visualizationData.success && visualizationData.predictions && visualizationData.predictions.length > 0) {
            updateVisualizationCharts(visualizationData.predictions);
            updateVisualizationStats(visualizationData.stats);
            console.log('All data refreshed:', visualizationData.predictions.length, 'predictions');
            showSuccessNotification(`All data refreshed! ${visualizationData.predictions.length} predictions loaded`);
        } else {
            showInfoNotification('No prediction data available');
        }
    })
    .catch((error) => {
        console.error('Error force refreshing all data:', error);
        showErrorNotification('Error refreshing all data');
    })
    .finally(() => {
        // Restore button
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
    });
}

function toggleLiveMode() {
    liveModeEnabled = !liveModeEnabled;
    const btn = document.getElementById('liveModeBtn');
    
    if (liveModeEnabled) {
        // Enable live mode - refresh every 2 seconds
        btn.innerHTML = '<i class="fas fa-broadcast-tower mr-2"></i>Live Mode: ON';
        btn.className = 'px-4 py-2 rounded-lg text-sm bg-green-500 text-white hover:bg-green-600 transition-colors font-medium';
        
        liveModeInterval = setInterval(() => {
            const visualizationSection = document.getElementById('section-visualization');
            const isVisible = visualizationSection && !visualizationSection.classList.contains('hidden');
            
            if (isVisible) {
                console.log('Live mode: Refreshing data...');
                loadVisualizationData();
            }
        }, 2000); // Refresh every 2 seconds in live mode
        
        showSuccessNotification('Live mode enabled - data refreshes every 2 seconds');
    } else {
        // Disable live mode
        btn.innerHTML = '<i class="fas fa-broadcast-tower mr-2"></i>Live Mode: OFF';
        btn.className = 'px-4 py-2 rounded-lg text-sm bg-purple-500 text-white hover:bg-purple-600 transition-colors font-medium';
        
        if (liveModeInterval) {
            clearInterval(liveModeInterval);
            liveModeInterval = null;
        }
        
        showInfoNotification('Live mode disabled');
    }
}

function debugDataStatus() {
    console.log('=== DEBUG DATA STATUS ===');
    
    // Check if visualization section is visible
    const visualizationSection = document.getElementById('section-visualization');
    const isVisible = visualizationSection && !visualizationSection.classList.contains('hidden');
    console.log('Visualization section visible:', isVisible);
    
    // Check current visualization type
    console.log('Current visualization type:', currentVisualizationType);
    
    // Check live mode status
    console.log('Live mode enabled:', liveModeEnabled);
    
    // Test API endpoint
    fetch('/admin/predictions/data?t=' + Date.now())
        .then(response => {
            console.log('API Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('API Response data:', data);
            if (data.success) {
                console.log('Total predictions:', data.predictions ? data.predictions.length : 0);
                console.log('Stats:', data.stats);
                showInfoNotification(`Debug: ${data.predictions ? data.predictions.length : 0} predictions found`);
            } else {
                console.log('API Error:', data.error);
                showErrorNotification(`Debug: API Error - ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Debug fetch error:', error);
            showErrorNotification(`Debug: Fetch Error - ${error.message}`);
        });
}
</script>
{% endblock %}
