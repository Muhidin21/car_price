{% extends "base.html" %}

{% block title %}Email Verification - Car Price Prediction{% endblock %}

{% block content %}
<div class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-8">
    <div class="text-center mb-8">
        <i class="fas fa-envelope-open text-4xl text-blue-600 mb-4"></i>
        <h2 class="text-3xl font-bold text-gray-800">Verify Your Email</h2>
        <p class="text-gray-600 mt-2">We've sent a verification code to</p>
        <p class="text-blue-600 font-semibold">{{ email }}</p>
    </div>

    <form method="POST" class="space-y-6">
        <div>
            <label for="otp" class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-key mr-2"></i>Verification Code
            </label>
            <input type="text" 
                   id="otp" 
                   name="otp" 
                   required 
                   maxlength="6"
                   pattern="[0-9]{6}"
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center text-2xl font-mono tracking-widest"
                   placeholder="000000"
                   autocomplete="one-time-code">
            <p class="text-xs text-gray-500 mt-1">Enter the 6-digit code from your email</p>
        </div>

        <button type="submit" 
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
            <i class="fas fa-check mr-2"></i>Verify Email
        </button>
    </form>

    <div class="mt-6 text-center">
        <p class="text-gray-600 text-sm mb-3">Didn't receive the code?</p>
        <button onclick="resendOTP()" 
                id="resendBtn"
                class="text-blue-600 hover:text-blue-800 font-semibold text-sm">
            <i class="fas fa-redo mr-1"></i>Resend Code
        </button>
        <div id="countdown" class="text-gray-500 text-sm mt-2"></div>
    </div>

    <!-- Information Card -->
    <div class="mt-8 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
        <h3 class="text-sm font-semibold text-yellow-700 mb-2">
            <i class="fas fa-info-circle mr-2"></i>Important Notes
        </h3>
        <ul class="text-xs text-yellow-600 space-y-1">
            <li><i class="fas fa-clock mr-2"></i>Code expires in 10 minutes</li>
            <li><i class="fas fa-shield-alt mr-2"></i>Check your spam folder if not received</li>
            <li><i class="fas fa-envelope mr-2"></i>Only the latest code is valid</li>
        </ul>
    </div>

    <div class="mt-6 text-center">
        <a href="{{ url_for('register') }}" class="text-gray-500 hover:text-gray-700 text-sm">
            <i class="fas fa-arrow-left mr-1"></i>Back to Registration
        </a>
    </div>
</div>

<script>
let resendCooldown = 0;

function resendOTP() {
    if (resendCooldown > 0) {
        return;
    }
    
    const resendBtn = document.getElementById('resendBtn');
    resendBtn.disabled = true;
    resendBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Sending...';
    
    fetch('/resend_otp', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ ' + data.message);
            startCooldown();
        } else {
            alert('❌ ' + data.message);
            resendBtn.disabled = false;
            resendBtn.innerHTML = '<i class="fas fa-redo mr-1"></i>Resend Code';
        }
    })
    .catch(error => {
        alert('❌ Error sending code. Please try again.');
        resendBtn.disabled = false;
        resendBtn.innerHTML = '<i class="fas fa-redo mr-1"></i>Resend Code';
    });
}

function startCooldown() {
    resendCooldown = 60; // 60 seconds cooldown
    const resendBtn = document.getElementById('resendBtn');
    const countdown = document.getElementById('countdown');
    
    const timer = setInterval(() => {
        countdown.textContent = `Resend available in ${resendCooldown} seconds`;
        resendCooldown--;
        
        if (resendCooldown < 0) {
            clearInterval(timer);
            resendBtn.disabled = false;
            resendBtn.innerHTML = '<i class="fas fa-redo mr-1"></i>Resend Code';
            countdown.textContent = '';
        }
    }, 1000);
}

// Auto-focus on OTP input
document.getElementById('otp').focus();

// Auto-submit when 6 digits are entered
document.getElementById('otp').addEventListener('input', function() {
    if (this.value.length === 6) {
        // Small delay to show the complete code
        setTimeout(() => {
            this.form.submit();
        }, 500);
    }
});

// Only allow numbers
document.getElementById('otp').addEventListener('keypress', function(e) {
    if (!/[0-9]/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'Enter'].includes(e.key)) {
        e.preventDefault();
    }
});
</script>
{% endblock %}